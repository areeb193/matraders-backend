# ==============================================================================
# CI/CD PIPELINE FOR MA TRADERS SYSTEM
# ==============================================================================
# This workflow automates the build, test, and deployment process
# Triggers: Push or Pull Request to main branch
# ==============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Environment variables
env:
  DOCKER_IMAGE_FRONTEND: areeb193/matraders-frontend
  DOCKER_IMAGE_BACKEND: areeb193/matraders-backend
  DOCKER_IMAGE_TAG: ${{ github.sha }}
  NODE_VERSION: '18'
  MONGODB_URI: mongodb://mongodb:27017/matraders_test

jobs:
  # =============================================================================
  # JOB 1: BUILD AND TEST
  # =============================================================================
  build-and-test:
    name: Build and Test Application
    runs-on: ubuntu-latest
    
    services:
      # MongoDB service for testing
      mongodb:
        image: mongo:7.0
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: testpassword
          MONGO_INITDB_DATABASE: matraders_test
        ports:
          - 27017:27017
        options: >-
          --health-cmd "echo 'db.runCommand(\"ping\").ok' | mongosh localhost:27017/test --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci

      - name: ğŸ—ï¸ Build Next.js application
        env:
          MONGO_URI: mongodb://admin:testpassword@localhost:27017/matraders_test?authSource=admin
          NEXT_PUBLIC_API_URL: http://localhost:3000
        run: |
          npm run build

      - name: ğŸ§ª Run tests (if available)
        env:
          MONGO_URI: mongodb://admin:testpassword@localhost:27017/matraders_test?authSource=admin
          NODE_ENV: test
        run: |
          # Create test script if it doesn't exist
          if grep -q '"test"' package.json; then
            npm test
          else
            echo "No tests found, skipping..."
            echo "âœ… Test step passed (no tests configured)"
          fi
        continue-on-error: false

      - name: ğŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: nextjs-build
          path: |
            .next
            public
          retention-days: 1

  # =============================================================================
  # JOB 2: BUILD AND PUSH DOCKER IMAGES
  # =============================================================================
  docker-build-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“ Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ“ Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_BACKEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_FRONTEND }}:latest
            ${{ env.DOCKER_IMAGE_FRONTEND }}:${{ env.DOCKER_IMAGE_TAG }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_FRONTEND }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE_FRONTEND }}:buildcache,mode=max
          build-args: |
            NODE_ENV=production

      - name: ğŸ³ Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_BACKEND }}:latest
            ${{ env.DOCKER_IMAGE_BACKEND }}:${{ env.DOCKER_IMAGE_TAG }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_BACKEND }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE_BACKEND }}:buildcache,mode=max
          build-args: |
            NODE_ENV=production

      - name: ğŸ” Verify Docker images
        run: |
          docker images | grep matraders

  # =============================================================================
  # JOB 3: DEPLOY TO KUBERNETES
  # =============================================================================
  deploy-kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: docker-build-push
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: ğŸ” Create Kubernetes secrets (if not exists)
        run: |
          # Create namespace if it doesn't exist
          kubectl create namespace matraders --dry-run=client -o yaml | kubectl apply -f -
          
          # Create Docker registry secret
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username=${{ secrets.DOCKER_USERNAME }} \
            --docker-password=${{ secrets.DOCKER_PASSWORD }} \
            --namespace=matraders \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: ğŸ“ Update deployment images
        run: |
          # Update image tags in deployment files
          sed -i "s|IMAGE_TAG|${{ env.DOCKER_IMAGE_TAG }}|g" k8s/deployment-frontend.yml
          sed -i "s|IMAGE_TAG|${{ env.DOCKER_IMAGE_TAG }}|g" k8s/deployment-backend.yml
          sed -i "s|DOCKER_USERNAME|${{ secrets.DOCKER_USERNAME }}|g" k8s/deployment-frontend.yml
          sed -i "s|DOCKER_USERNAME|${{ secrets.DOCKER_USERNAME }}|g" k8s/deployment-backend.yml

      - name: ğŸš€ Deploy MongoDB to Kubernetes
        run: |
          kubectl apply -f k8s/mongodb-deployment.yml -n matraders
          kubectl apply -f k8s/mongodb-service.yml -n matraders

      - name: â³ Wait for MongoDB to be ready
        run: |
          kubectl wait --for=condition=ready pod -l app=mongodb -n matraders --timeout=300s

      - name: ğŸš€ Deploy Backend to Kubernetes
        run: |
          kubectl apply -f k8s/configmap.yml -n matraders
          kubectl apply -f k8s/deployment-backend.yml -n matraders
          kubectl apply -f k8s/service-backend.yml -n matraders

      - name: ğŸš€ Deploy Frontend to Kubernetes
        run: |
          kubectl apply -f k8s/deployment-frontend.yml -n matraders
          kubectl apply -f k8s/service-frontend.yml -n matraders

      - name: â³ Wait for deployments to be ready
        run: |
          kubectl rollout status deployment/matraders-backend -n matraders --timeout=300s
          kubectl rollout status deployment/matraders-frontend -n matraders --timeout=300s

      - name: ğŸ” Verify deployment
        run: |
          echo "=== Pods ==="
          kubectl get pods -n matraders
          echo ""
          echo "=== Services ==="
          kubectl get services -n matraders
          echo ""
          echo "=== Deployments ==="
          kubectl get deployments -n matraders

      - name: ğŸ“Š Get deployment status
        if: always()
        run: |
          kubectl describe deployment matraders-frontend -n matraders
          kubectl describe deployment matraders-backend -n matraders
          kubectl logs -l app=matraders-frontend -n matraders --tail=50 || true
          kubectl logs -l app=matraders-backend -n matraders --tail=50 || true

  # =============================================================================
  # JOB 4: NOTIFICATION (Optional)
  # =============================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build-push, deploy-kubernetes]
    if: always()
    
    steps:
      - name: ğŸ“§ Send success notification
        if: needs.deploy-kubernetes.result == 'success'
        run: |
          echo "âœ… Deployment successful!"
          echo "Frontend: ${{ env.DOCKER_IMAGE_FRONTEND }}:${{ env.DOCKER_IMAGE_TAG }}"
          echo "Backend: ${{ env.DOCKER_IMAGE_BACKEND }}:${{ env.DOCKER_IMAGE_TAG }}"

      - name: âš ï¸ Send failure notification
        if: needs.deploy-kubernetes.result == 'failure' || needs.build-and-test.result == 'failure' || needs.docker-build-push.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs for more details."
